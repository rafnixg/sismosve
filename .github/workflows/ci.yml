name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.11, 3.13]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio httpx

    - name: Lint with flake8
      run: |
        pip install flake8
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Test application startup
      run: |
        timeout 30s python run.py test || echo "Application test completed"

    - name: Check API endpoints
      run: |
        python -c "
        import sys
        sys.path.append('.')
        from app.main import app
        from fastapi.testclient import TestClient
        client = TestClient(app)
        response = client.get('/api/health')
        assert response.status_code == 200
        print('✅ Health check passed')
        "

#   code-quality:
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v4

#     - name: Set up Python
#       uses: actions/setup-python@v4
#       with:
#         python-version: 3.11

#     - name: Install quality tools
#       run: |
#         pip install black isort bandit safety

#     - name: Check code formatting with Black
#       run: black --check --diff .

#     - name: Check import sorting with isort
#       run: isort --check-only --diff .

#     - name: Security check with Bandit
#       run: bandit -r . -f json -o bandit-report.json || true

#     - name: Check dependencies with Safety
#       run: safety check --json --output safety-report.json || true

#     - name: Upload security reports
#       uses: actions/upload-artifact@v4
#       with:
#         name: security-reports
#         path: |
#           bandit-report.json
#           safety-report.json

#   docker-test:
#     runs-on: ubuntu-latest
#     needs: test
    
#     steps:
#     - uses: actions/checkout@v4

#     - name: Set up Docker Buildx
#       uses: docker/setup-buildx-action@v3

#     - name: Build Docker image for testing
#       uses: docker/build-push-action@v6
#       with:
#         context: .
#         load: true
#         tags: sismosve:test
#         cache-from: type=gha
#         cache-to: type=gha,mode=max

#     - name: Test Docker image
#       run: |
#         # Start container in background
#         docker run -d --name sismosve-test -p 8000:8000 sismosve:test
        
#         # Wait for application to start
#         sleep 10
        
#         # Test health endpoint
#         curl -f http://localhost:8000/api/health || exit 1
        
#         # Test main page
#         curl -f http://localhost:8000/ || exit 1
        
#         # Clean up
#         docker stop sismosve-test
#         docker rm sismosve-test
        
#         echo "✅ Docker image tests passed"

#   notify:
#     runs-on: ubuntu-latest
#     needs: [test, code-quality, docker-test]
#     if: always()
    
#     steps:
#     - name: Notify success
#       if: needs.test.result == 'success' && needs.code-quality.result == 'success' && needs.docker-test.result == 'success'
#       run: |
#         echo "✅ All CI checks passed successfully!"
#         echo "Ready for Docker build and deployment"

#     - name: Notify failure
#       if: needs.test.result == 'failure' || needs.code-quality.result == 'failure' || needs.docker-test.result == 'failure'
#       run: |
#         echo "❌ Some CI checks failed"
#         echo "Please review the errors before proceeding"
#         exit 1